<!DOCTYPE html>
<html lang="en">
<head>
	  <meta charset="UTF-8">
	  <title>用户信息</title>
	  <meta name="renderer" content="webkit">
	  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	  <link rel="stylesheet" href="../../layui/css/layui.css"  media="all">
	  <script src="../../layui/layui.js" charset="utf-8"></script>
	  <script src="../../js/z.js" charset="utf-8"></script>
      <style>
            #tab_box{margin:0;}
            .layui-hidden-i i{display: none;}
	        .new_layui_table table th,.new_layui_table table td{max-width: 300px;}
	        .new_layui_table .layui-table-cell{height: auto;white-space:normal;}
	        .new_table_page{width: 100%;overflow:hidden;}
      </style>

</head>
<body>

<!-- <a href=".<%= list.url %>"> -->

<div class="layui-tab" lay-filter="demo" lay-allowclose="true" id="tab_box">
	  <ul class="layui-tab-title">
            <% list.forEach(function(list,index){ %>
                <li lay-id="<%=index%>" <% if(index==0){ %> class="layui-this layui-hidden-i" <% } %> ><%= list.title %></li>
            <% }) %>
	  </ul>
	  <div class="layui-tab-content">
        <div class="layui-tab-item layui-show" >
                    <!-- //////////////////////////////////////// -->

					        <div id="table"></div>
					        <!-- 分页 -->
					        <div id="test1"></div>
                    <!-- //////////////////////////////////////// -->
        </div>
	  </div>
</div>
 
<script type="text/html" id="barDemo">
		  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail" lay-filter="barDemo">查看</a>
		  <a class="layui-btn layui-btn-xs" lay-event="edit" lay-filter="barDemo">设置权限</a>
		  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del" lay-filter="barDemo">设置角色</a>
</script>
 
<script type="text/html" id="checkboxTpl">
	  <!-- 这里的 checked 的状态只是演示 -->
	  <input type="checkbox" name="lock" value="{{d.id}}" title="封号" lay-filter="lockDemo" {{ d.is_valid == 0 ? 'checked' : '' }} {{ d.is_admin == 1 ? 'disabled' : '' }}>
</script>

 <script>
layui.use(['jquery','form','element','laypage','table'], function(){			 
			  var $ = layui.jquery
				  ,form = layui.form
				  ,laypage = layui.laypage
				  ,table = layui.table	
				  ,element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块

			    var tab_box = $('#tab_box')[0],  
			        tab_title = tab_box.children[0],  //tab导航
			        tab_content = tab_box.children[1]; //tab导航内容
                    changeTCH();
              function changeTCH(){
			        tab_content.style.height=window.innerHeight-62+'px';
			        tab_content.style.overflowY='scroll';
			        var tab_content_iframes=tab_content.getElementsByTagName('iframe');
			        for(var i=0;i<tab_content_iframes.length;i++){
					        tab_content_iframes[i].style.width='100%';
					        tab_content_iframes[i].style.height=window.innerHeight-62+'px';
					        tab_content_iframes[i].style.overflowY='scroll';
			        }
              }
			  //触发事件
			  var active = {
					    tabAdd: function(id,tabId,title,url){
					         //新增一个Tab项						      
						      var content='<iframe scrolling="auto" allowtransparency="true" id="layui-layer-iframe1" name="layui-layer-iframe1" onload="this.className=\'\';" class="" frameborder="0" src="'+url+'" style="width:100%;overflow-y:scroll;height:'+(window.innerHeight-62)+'px'+'"></iframe>';
							      element.tabAdd('demo', {
								        title: title //用于演示
								        ,content: content 
								        ,id: tabId //实际使用一般是规定好的id，这里以时间戳模拟下
							      })
					    }
					    ,tabDelete: function(othis){
						      //删除指定Tab项
						      element.tabDelete('demo', '44'); //删除：“商品管理”
						      othis.addClass('layui-btn-disabled');
					    }
					    ,tabChange: function(id){
						      //切换到指定Tab项
						      element.tabChange('demo', id); //切换到：用户管理
					    }
			  };
			  
			  $('.site-demo-active').on('click', function(){
					    var _this=$(this),
					        hasTab=false,//是否有这个tab
					        user_id=_this[0].getAttribute('data-userId'),
					        tabId=_this[0].getAttribute('data-tabId'),
					        url=_this[0].getAttribute('data-url'),
					        title=_this[0].getAttribute('title');

						    for(var i=0;i<tab_title.children.length;i++){
						    	   if(tab_title.children[i].getAttribute('lay-id')==tabId){
	                                      hasTab=true;
						    	   }
						    }
						    url=url+'/'+user_id;
						    if(hasTab){//导航已经有这个了
	                                active.tabChange(tabId);
	                                var li_index = $('#tab_box .layui-tab-title .layui-this')[0].getAttribute('data-li-index');
	                                tab_content.children[li_index].getElementsByTagName('iframe')[0].src=url;
						    }else{//导航没有添加
								    active.tabAdd(user_id,tabId,title,url);
								    active.tabChange(tabId);
								    tab_title.children[tab_title.children.length-1].setAttribute('data-li-index',(tab_title.children.length-1))
						    }
						    // console.log(tab_title.children[tab_title.children.length-1])

			  });
			  
			  //Hash地址的定位
			  var layid = location.hash.replace(/^#demo=/, '');
			  element.tabChange('demo', layid);
			  
			  element.on('tab(demo)', function(elem){
			        location.hash = 'demo='+ $(this).attr('lay-id');
			        // 
			  });


		  //监听指定开关
		  form.on('switch(switchTest)', function(data){
			    layer.msg('开关checked：'+ (this.checked ? 'true' : 'false'), {
			      offset: '6px'
			    });
			    layer.tips('温馨提示：请注意开关状态的文字可以随意定义，而不仅仅是ON|OFF', data.othis)
		  });	  
		  //监听提交
		  form.on('submit(demo1)', function(data){
			    layer.alert(JSON.stringify(data.field), {
			      title: '最终的提交信息'
			    })
			    return false;
		  }); 

		//表格实例
		table.render({
			     elem: '#table'
			    ,url:'/admin/user/list'
			    ,cols: [[ //标题栏
					      {field: 'id', title: 'ID', sort: true}
					      ,{field: 'username', title: '用户名'}
					      ,{field: 'sex', title: '性别'}
					      ,{field: 'phone', title: '手机'}
					      ,{field: 'email', title: '邮箱'}
					      ,{field: 'is_admin', title: '是否管理员'}
					      ,{field:'lock', title:'是否封号', templet: '#checkboxTpl', unresize: true}
					      ,{field: 'template', title: '操作',  toolbar: '#barDemo', align:'center', unresize: true}
			    ]]
			    // ,data: [{"id":1,"username":'username',"sex":"sex","phone":"phone","email":"email","is_admin":"is_admin"}]
			    //,skin: 'line' //表格风格
			    ,even: true
			    ,page: true //是否显示分页
			    ,response: {
					  // {"code":0,"msg":"","count":1000,"data":[]} 默认
					  // statusName: 'status' //数据状态的字段名称，默认：code
					  statusCode: 200 //成功的状态码，默认：0
					  // ,msgName: 'hint' //状态信息的字段名称，默认：msg
					  // ,countName: 'total' //数据总数的字段名称，默认：count
					  // ,dataName: 'rows' //数据列表的字段名称，默认：data
				} 
			    ,done: function(res, curr, count){
					    //如果是异步请求数据方式，res即为你接口返回的信息。
					    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
					    console.log(res);
					    
					    //得到当前页码
					    console.log(curr); 
					    
					    //得到数据总量
					    console.log(count);
				}
			    //,limits: [5, 7, 10]
			    //,limit: 5 //每页默认显示的数量
		  });

	  //监听封号操作
	  form.on('checkbox(lockDemo)', function(obj){
	         // layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);
	         var _this=this;
	         $.ajax({
		         	   url:'/admin/user/closeUser',
		         	   data:{
		         	   	    id:_this.value
		         	   },
		         	   success:function(res){
			         	   	    res = JSON.parse(res);
			         	   	    // $(selector).removeProp(property)
			         	   	    layer.msg(res.msg);
			         	   	    // if(res.code==300){
			         	   	    // 	 console.log(obj.othis.hasClass('layui-form-checked'));
			         	   	    // 	 if(obj.othis.hasClass('layui-form-checked')){
			         	   	    // 	 	    obj.othis.removeClass('layui-form-checked');
			         	   	    // 	 }else{
	                    //                     obj.othis.addClass('layui-form-checked');
			         	   	    // 	 }
			         	   	    // 	 return false;
			         	   	    // }
			         	   	    if(res.code!=200){
			         	   	    	 if(obj.elem.checked){
						         	   	    	 obj.othis.removeClass('layui-form-checked');
						         	   	    	 obj.elem.removeProperty('checked');
				         	   	    	}else{
						         	   	    	 obj.othis.addClass('layui-form-checked');
						         	   	    	 obj.elem.setAttribute('checked',true);
				         	   	    	}

			         	   	    }
			         	   	    
		         	   },
		         	   error:function(err){
		         	   	    console.log(err);
		         	   }
	         })
	  });

		 //监听工具条 (操作)
	  table.on('tool(barDemo)', function(obj){
		        var data = obj.data;
		        console.log(data);
			    if(obj.event === 'detail'){
			      layer.msg('ID：'+ data.id + ' 的查看操作');
			    } else if(obj.event === 'del'){
			      layer.confirm('真的删除行么', function(index){
			        obj.del();
			        layer.close(index);
			      });
			    } else if(obj.event === 'edit'){
			      layer.alert('编辑行：<br>'+ JSON.stringify(data))
			    }
	  });
});
</script>
</body>
</html>